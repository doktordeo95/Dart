<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Darts Score Counter</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#1a1a1a;color:#fff;height:100vh;overflow:hidden}
.screen{height:100vh;display:none;flex-direction:column}
.screen.active{display:flex}
.header{background:#242424;padding:10px 16px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center}
.header strong{font-size:14px}

/* SETUP */
.setup{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column}
.setup-content{flex:1;overflow-y:auto}
.setup-card{background:#242424;border:1px solid #333;border-radius:10px;padding:12px;margin-bottom:10px}
.setup-card h3{font-size:11px;color:#00ff88;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
.setup label{font-size:12px;color:#ccc;display:block;margin-top:6px}
.setup input,.setup select{width:100%;padding:9px;margin-top:4px;background:#1a1a1a;border:1px solid #333;color:#fff;border-radius:6px;font-size:14px}

.setup-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.setup-grid.three{grid-template-columns:repeat(3,1fr)}

.toggle{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:12px;color:#ccc}
.toggle input{width:auto}

.start-button{width:100%;padding:16px;margin-top:12px;background:#00ff88;color:#000;border:none;border-radius:10px;font-size:18px;font-weight:800;cursor:pointer;flex-shrink:0}

/* GAME */
.match-info{display:flex;gap:14px;font-size:12px}
.match-info strong{color:#00ff88}
.players{flex:1;display:flex;flex-direction:column;min-height:0;overflow-y:auto}
.player{padding:12px 14px;background:#242424;border-bottom:1px solid #1a1a1a;display:flex;flex-direction:column;justify-content:center;flex-shrink:0}
.player.active{background:#2b2b2b;border-left:4px solid #00ff88}
.player.inactive{opacity:.45}
.player-header{display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px}
.record{display:flex;gap:8px;font-size:10px;color:#ccc}
.score{text-align:center;font-size:48px;font-weight:900;line-height:1;margin:4px 0}
.player.active .score{color:#00ff88}
.stats{display:flex;justify-content:center;gap:14px;font-size:10px;color:#aaa;margin-top:3px}
.checkout{text-align:center;font-size:10px;color:#ffc107;margin-top:3px}

.input{background:#1a1a1a;border-top:2px solid #00ff88;padding:8px;display:flex;flex-direction:column;flex-shrink:0}
.display{background:#242424;border:2px solid #333;border-radius:6px;height:44px;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:900;color:#00ff88;margin-bottom:6px}
.display.error{border-color:#dc3545;color:#dc3545}
.pad{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:6px}
.pad button{padding:0;font-size:17px;font-weight:700;background:#242424;color:#fff;border:1px solid #333;border-radius:5px;height:44px;display:flex;align-items:center;justify-content:center}
.pad button.zero{grid-column:span 2}
.actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;background:#1a1a1a;padding-bottom:max(8px, env(safe-area-inset-bottom))}
.actions button{padding:0;font-weight:800;border-radius:5px;border:none;height:44px;font-size:13px;display:flex;align-items:center;justify-content:center}
.clear{background:#dc3545;color:#fff}
.undo{background:#ffc107;color:#000}
.undo:disabled{background:#333;color:#666;cursor:not-allowed}
.submit{background:#00ff88;color:#000}

/* WIN MODAL */
.modal{position:fixed;inset:0;background:linear-gradient(180deg,#00ff88,#0f5132);display:none;align-items:center;justify-content:center;color:#000}
.modal.active{display:flex}
.modal-content{background:#fff;border-radius:16px;padding:22px;width:90%;max-width:420px;text-align:center}
.modal-content h2{font-size:20px;margin-bottom:10px}
.modal-content .winner{font-size:26px;font-weight:900;color:#00aa55;margin-bottom:14px}
.modal-content .stat{font-size:14px;margin:6px 0}
.modal-content button{margin-top:14px;width:100%;padding:14px;border:none;border-radius:8px;font-size:16px;font-weight:800;cursor:pointer}
.modal-content .again{background:#00ff88}
.modal-content .exit{background:#242424;color:#fff;margin-top:8px}
</style>
</head>
<body>
<!-- SETUP -->
<div class="screen active" id="setup">
  <div class="header"><strong>üéØ Darts Score Counter</strong></div>
  <div class="setup">
    <div class="setup-card">
      <h3>Spel</h3>
      <div class="setup-grid">
        <div>
          <label for="mode">Startpo√§ng</label>
          <select id="mode">
            <option value="501">501</option>
            <option value="301">301</option>
          </select>
        </div>
        <div>
          <label for="finish">Utg√•ng</label>
          <select id="finish">
            <option value="any">Valfri</option>
            <option value="double">Dubbel</option>
            <option value="triple">Trippel</option>
          </select>
        </div>
      </div>
    </div>

    <div class="setup-card">
      <h3>Matchformat</h3>
      <div class="setup-grid three">
        <div>
          <label for="legsToWin">Legs / set</label>
          <input id="legsToWin" type="number" value="3" min="1" />
        </div>
        <div>
          <label for="setsToWin">Sets / match</label>
          <input id="setsToWin" type="number" value="2" min="1" />
        </div>
        <div>
          <label for="startPlayer">Startspelare</label>
          <select id="startPlayer"></select>
        </div>
      </div>
      <div class="toggle">
        <input type="checkbox" id="alternateStart" checked />
        <label for="alternateStart">V√§xla startspelare varje leg</label>
      </div>
    </div>

    <div class="setup-card">
      <h3>Spelare</h3>
      <label for="numPlayers">Antal spelare</label>
      <select id="numPlayers">
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
      <div id="playerInputs"></div>
    </div>

    <button class="submit" style="width:100%" onclick="startGame()">Starta match</button>
  </div>
</div>

<!-- GAME -->
<div class="screen" id="game">
  <div class="header">
    <button onclick="resetAll()">‚Üê</button>
    <div class="match-info">
      <div>Leg <strong id="leg">1</strong></div>
      <div>Set <strong id="set">1</strong></div>
      <div>F√∂rst till <strong id="legsTarget"></strong> legs</div>
      <div>F√∂rst till <strong id="setsTarget"></strong> sets</div>
    </div>
  </div>
  <div class="players" id="players"></div>
  <div class="input">
    <div class="display" id="display">0</div>
    <div class="pad">
      <button onclick="num(1)">1</button>
      <button onclick="num(2)">2</button>
      <button onclick="num(3)">3</button>
      <button onclick="num(4)">4</button>
      <button onclick="num(5)">5</button>
      <button onclick="num(6)">6</button>
      <button onclick="num(7)">7</button>
      <button onclick="num(8)">8</button>
      <button onclick="num(9)">9</button>
      <button class="zero" onclick="num(0)">0</button>
      <button onclick="back()">‚å´</button>
    </div>
    <div class="actions">
      <button class="clear" onclick="clearInput()">Rensa</button>
      <button class="undo" id="undoBtn" onclick="undo()" disabled>√Öngra</button>
      <button class="submit" onclick="submit()">OK</button>
    </div>
  </div>
</div>

<!-- WIN MODAL -->
<div class="modal" id="winModal">
  <div class="modal-content" id="winContent"></div>
</div>

<script>
const CHECKOUTS = {
  double: {
    170: 'T20 T20 Bull',
    167: 'T20 T19 Bull',
    164: 'T20 T18 Bull',
    161: 'T20 T17 Bull',
    160: 'T20 T20 D20',
    158: 'T20 T20 D19',
    157: 'T20 T19 D20',
    156: 'T20 T20 D18',
    155: 'T20 T19 D19',
    154: 'T20 T18 D20',
    153: 'T20 T19 D18',
    152: 'T20 T20 D16',
    151: 'T20 T17 D20',
    150: 'T20 T18 D18',
    149: 'T20 T19 D16',
    148: 'T20 T16 D20',
    147: 'T20 T17 D18',
    146: 'T20 T18 D16',
    145: 'T20 T15 D20',
    144: 'T20 T20 D12',
    143: 'T20 T17 D16',
    142: 'T20 T14 D20',
    141: 'T20 T19 D12',
    140: 'T20 T16 D16',
    139: 'T20 T13 D20',
    138: 'T20 T18 D12',
    137: 'T20 T15 D16',
    136: 'T20 T20 D8',
    135: 'T20 T17 D12',
    134: 'T20 T14 D16',
    133: 'T20 T19 D8',
    132: 'T20 T16 D12',
    131: 'T20 T13 D16',
    130: 'T20 T18 D8',
    129: 'T19 T16 D12',
    128: 'T18 T14 D16',
    127: 'T20 T17 D8',
    126: 'T19 T19 D6',
    125: 'T18 T13 D16',
    124: 'T20 T16 D8',
    123: 'T19 T16 D9',
    122: 'T18 T18 D7',
    121: 'T17 T10 D20',
    120: 'T20 20 D20',
    119: 'T19 T12 D13',
    118: 'T20 18 D20',
    117: 'T20 17 D20',
    116: 'T20 16 D20',
    115: 'T19 18 D20',
    114: 'T20 14 D20',
    113: 'T19 16 D20',
    112: 'T20 12 D20',
    111: 'T19 14 D20',
    110: 'T20 10 D20',
    109: 'T20 9 D20',
    108: 'T20 8 D20',
    107: 'T19 10 D20',
    106: 'T20 6 D20',
    105: 'T19 8 D20',
    104: 'T20 4 D20',
    103: 'T19 6 D20',
    102: 'T20 2 D20',
    101: 'T17 10 D20',
    100: 'T20 D20',
    99: 'T19 10 D16',
    98: 'T20 D19',
    97: 'T19 D20',
    96: 'T20 D18',
    95: 'T19 D19',
    94: 'T18 D20',
    93: 'T19 D18',
    92: 'T20 D16',
    91: 'T17 D20',
    90: 'T18 D18',
    89: 'T19 D16',
    88: 'T16 D20',
    87: 'T17 D18',
    86: 'T18 D16',
    85: 'T15 D20',
    84: 'T20 D12',
    83: 'T17 D16',
    82: 'T14 D20',
    81: 'T19 D12',
    80: 'T20 D10',
    79: 'T19 D11',
    78: 'T18 D12',
    77: 'T15 D16',
    76: 'T20 D8',
    75: 'T17 D12',
    74: 'T14 D16',
    73: 'T19 D8',
    72: 'T16 D12',
    71: 'T13 D16',
    70: 'T18 D8',
    69: 'T19 D6',
    68: 'T20 D4',
    67: 'T17 D8',
    66: 'T10 D18',
    65: 'T15 D10',
    64: 'T16 D8',
    63: 'T13 D12',
    62: 'T10 D16',
    61: 'T15 D8',
    60: '20 D20',
    59: '19 D20',
    58: '18 D20',
    57: '17 D20',
    56: '16 D20',
    55: '15 D20',
    54: '14 D20',
    53: '13 D20',
    52: '12 D20',
    51: '11 D20',
    50: '10 D20',
    49: '9 D20',
    48: '8 D20',
    47: '7 D20',
    46: '6 D20',
    45: '5 D20',
    44: '4 D20',
    43: '3 D20',
    42: '2 D20',
    41: '9 D16',
    40: 'D20',
    39: '7 D16',
    38: 'D19',
    37: '5 D16',
    36: 'D18',
    35: '3 D16',
    34: 'D17',
    33: '1 D16',
    32: 'D16',
    30: 'D15',
    28: 'D14',
    27: '19 D4',
    26: 'D13',
    25: '9 D8',
    24: 'D12',
    22: 'D11',
    21: '5 D8',
    20: 'D10',
    18: 'D9',
    16: 'D8',
    14: 'D7',
    12: 'D6',
    10: 'D5',
    8: 'D4',
    6: 'D3',
    4: 'D2',
    2: 'D1'
  },
  any: {
    180: 'T20 T20 T20',
    177: 'T20 T19 T20',
    174: 'T20 T20 T18',
    171: 'T20 T19 T18',
    170: 'T20 T20 Bull',
    168: 'T20 T20 T16',
    167: 'T20 T19 Bull',
    165: 'T20 T19 T16',
    164: 'T20 T18 Bull',
    162: 'T20 T20 T14',
    161: 'T20 T17 Bull',
    160: 'T20 T20 D20',
    159: 'T20 T19 T14',
    158: 'T20 T20 D19',
    157: 'T20 T19 D20',
    156: 'T20 T20 D18',
    155: 'T20 T19 D19',
    154: 'T20 T18 D20',
    153: 'T20 T19 D18',
    152: 'T20 T20 D16',
    151: 'T20 T17 D20',
    150: 'T20 T18 D18',
    100: 'T20 D20',
    99: 'T20 19 D11',
    98: 'T20 D19',
    97: 'T19 D20',
    96: 'T20 D18',
    95: 'T19 D19',
    94: 'T18 D20',
    93: 'T19 D18',
    92: 'T20 D16',
    91: 'T17 D20',
    90: 'T18 D18',
    50: 'Bull',
    40: 'D20',
    32: 'D16',
    20: 'D10',
    10: 'D5'
  },
  triple: {
    180: 'T20 T20 T20',
    177: 'T20 T19 T20',
    174: 'T20 T20 T18',
    171: 'T20 T19 T18',
    168: 'T20 T20 T16',
    165: 'T20 T19 T16',
    162: 'T20 T20 T14',
    159: 'T20 T19 T14',
    156: 'T20 T20 T12',
    153: 'T20 T19 T12',
    150: 'T20 T20 T10',
    147: 'T20 T19 T10',
    144: 'T20 T20 T8',
    141: 'T20 T19 T8',
    138: 'T20 T20 T6',
    135: 'T20 T19 T6',
    132: 'T20 T20 T4',
    129: 'T20 T19 T4',
    126: 'T20 T20 T2',
    123: 'T20 T19 T2',
    120: 'T20 T20 20',
    117: 'T20 T19 20',
    114: 'T20 T18 20',
    111: 'T20 T17 20',
    108: 'T20 T16 20',
    105: 'T20 T15 20',
    102: 'T20 T14 20',
    99: 'T20 T13 20',
    96: 'T20 T12 20',
    93: 'T20 T11 20',
    90: 'T20 T10 20',
    87: 'T20 T9 20',
    84: 'T20 T8 20',
    81: 'T20 T7 20',
    78: 'T20 T6 20',
    75: 'T20 T5 20',
    72: 'T20 T4 20',
    69: 'T20 T3 20',
    66: 'T20 T2 20',
    63: 'T20 T1 20',
    60: 'T20 20 20',
    57: 'T19 20 20',
    54: 'T18 20 20',
    51: 'T17 20 20',
    48: 'T16 20 20',
    45: 'T15 20 20',
    42: 'T14 20 20',
    39: 'T13 20 20',
    36: 'T12 20 20',
    33: 'T11 20 20',
    30: 'T10 20 20',
    27: 'T9 20 20',
    24: 'T8 20 20',
    21: 'T7 20 20',
    18: 'T6 20 20',
    15: 'T5 20 20',
    12: 'T4 20 20',
    9: 'T3 20 20',
    6: 'T2 20 20',
    3: 'T1 20 20'
  }
};
let state = null;

function renderPlayerInputs() {
  const container = document.getElementById('playerInputs');
  const startSel = document.getElementById('startPlayer');
  container.innerHTML = '';
  startSel.innerHTML = '';
  const n = +document.getElementById('numPlayers').value;
  for (let i = 1; i <= n; i++) {
    container.innerHTML += `<label for="p${i}">Spelare ${i}</label><input id="p${i}" value="Spelare ${i}">`;
    startSel.innerHTML += `<option value="${i-1}">Spelare ${i}</option>`;
  }
}

function startGame() {
  const n = +numPlayers.value;
  state = {
    start: +mode.value,
    finish: finish.value,
    legsToWin: +legsToWin.value,
    setsToWin: +setsToWin.value,
    leg: 1,
    set: 1,
    startIndex: +startPlayer.value,
    current: +startPlayer.value,
    alternate: alternateStart.checked,
    input: '',
    finished: false,
    history: [],
    players: Array.from({length: n}, (_, i) => ({
      name: document.getElementById(`p${i+1}`).value,
      score: +mode.value,
      legs: 0,
      sets: 0,
      rounds: [],
      setRounds: [],
      highest: 0
    }))
  };
  save();
  setup.classList.remove('active');
  game.classList.add('active');
  legsTarget.textContent = state.legsToWin;
  setsTarget.textContent = state.setsToWin;
  render();
}

function save() {
  localStorage.setItem('dartsState', JSON.stringify(state));
}

function load() {
  const s = localStorage.getItem('dartsState');
  if (s) {
    state = JSON.parse(s);
    if (!state.history) state.history = []; // Ensure history exists
    setup.classList.remove('active');
    game.classList.add('active');
    legsTarget.textContent = state.legsToWin;
    setsTarget.textContent = state.setsToWin;
    render();
  }
}

function resetAll() {
  localStorage.removeItem('dartsState');
  state = null;
  game.classList.remove('active');
  setup.classList.add('active');
  initSetup();
}

function avg(a) {
  return a.length ? Math.round(a.reduce((x, y) => x + y, 0) / a.length) : 0;
}

function render() {
  leg.textContent = state.leg;
  set.textContent = state.set;
  players.innerHTML = '';
  state.players.forEach((p, i) => {
    const co = CHECKOUTS[state.finish]?.[p.score];
    players.innerHTML += `
      <div class="player ${i === state.current && !state.finished ? 'active' : 'inactive'}">
        <div class="player-header">
          <strong>${p.name}</strong>
          <div class="record">Legs ${p.legs}/${state.legsToWin} Sets ${p.sets}/${state.setsToWin}</div>
        </div>
        <div class="score">${p.score}</div>
        <div class="stats">AVG ${avg(p.rounds)} | SET ${avg(p.setRounds)}</div>
        ${co ? `<div class="checkout">Checkout: ${co}</div>` : ''}
      </div>`;
  });
  
  // Update undo button state
  const undoBtn = document.getElementById('undoBtn');
  if (undoBtn) {
    const canUndo = state.history && state.history.length > 0 && !state.finished;
    undoBtn.disabled = !canUndo;
    console.log('Undo button state:', canUndo, 'History length:', state.history?.length || 0);
  }
}

function num(n) {
  if (state.finished) return;
  state.input = (state.input + n).slice(0, 3);
  display.textContent = state.input;
  display.classList.remove('error');
}

function back() {
  state.input = state.input.slice(0, -1);
  display.textContent = state.input || '0';
  display.classList.remove('error');
}

function clearInput() {
  state.input = '';
  display.textContent = '0';
  display.classList.remove('error');
}

function validFinish(v) {
  if (state.finish === 'any') return true;
  if (state.finish === 'double') return v % 2 === 0;
  if (state.finish === 'triple') return v % 3 === 0;
}

function submit() {
  const v = +state.input;
  
  // Validate input
  if (!v || v > 180) {
    display.classList.add('error');
    return;
  }

  const p = state.players[state.current];

  // Bust - score would go negative
  if (p.score - v < 0) {
    display.classList.add('error');
    setTimeout(() => {
      // Save to history even on bust so we can undo the bust
      saveToHistory();
      next();
    }, 500);
    return;
  }

  // Bust - score would be zero but finish is invalid
  if (p.score - v === 0 && !validFinish(v)) {
    display.classList.add('error');
    setTimeout(() => {
      // Save to history even on bust so we can undo the bust
      saveToHistory();
      next();
    }, 500);
    return;
  }

  // Save state to history before making changes
  saveToHistory();

  // Valid score
  p.score -= v;
  p.rounds.push(v);
  p.setRounds.push(v);
  p.highest = Math.max(p.highest, v);

  // Check for leg win
  if (p.score === 0) {
    p.legs++;

    // Check for set win
    if (p.legs >= state.legsToWin) {
      p.sets++;
      
      // Reset for new set
      state.players.forEach(pl => {
        pl.legs = 0;
        pl.setRounds = [];
        pl.score = state.start;
      });
      
      state.set++;
      state.leg = 1;

      // Check for match win
      if (p.sets >= state.setsToWin) {
        state.finished = true;
        save();
        render();
        showWin(p);
        return;
      }
    } else {
      // New leg, same set
      state.players.forEach(pl => pl.score = state.start);
      state.leg++;
    }

    // Rotate start player if enabled
    if (state.alternate) {
      state.startIndex = (state.startIndex + 1) % state.players.length;
    }
    
    state.current = state.startIndex;
    clearInput();
    save();
    render();
    return;
  }

  // Normal turn - move to next player
  next();
}

function next() {
  state.current = (state.current + 1) % state.players.length;
  clearInput();
  save();
  render();
}

function saveToHistory() {
  // Deep clone the current state
  const snapshot = {
    players: state.players.map(p => ({
      score: p.score,
      legs: p.legs,
      sets: p.sets,
      rounds: [...p.rounds],
      setRounds: [...p.setRounds],
      highest: p.highest
    })),
    current: state.current,
    leg: state.leg,
    set: state.set,
    startIndex: state.startIndex
  };
  
  // Keep only last 20 moves to save memory
  if (!state.history) state.history = [];
  state.history.push(snapshot);
  if (state.history.length > 20) {
    state.history.shift();
  }
  console.log('Saved to history, length now:', state.history.length);
}

function undo() {
  console.log('Undo called, history:', state.history);
  if (!state.history || state.history.length === 0 || state.finished) {
    console.log('Cannot undo - no history or game finished');
    return;
  }
  
  const snapshot = state.history.pop();
  console.log('Restoring snapshot:', snapshot);
  
  // Restore state
  state.players.forEach((p, i) => {
    p.score = snapshot.players[i].score;
    p.legs = snapshot.players[i].legs;
    p.sets = snapshot.players[i].sets;
    p.rounds = [...snapshot.players[i].rounds];
    p.setRounds = [...snapshot.players[i].setRounds];
    p.highest = snapshot.players[i].highest;
  });
  
  state.current = snapshot.current;
  state.leg = snapshot.leg;
  state.set = snapshot.set;
  state.startIndex = snapshot.startIndex;
  
  clearInput();
  save();
  render();
  console.log('Undo complete, new history length:', state.history.length);
}

function showWin(winner) {
  let html = `<h2>üéâ Match slut!</h2><div class="winner">${winner.name} vinner</div>`;
  state.players.forEach(p => {
    html += `<div class="stat"><strong>${p.name}</strong><br>Snitt: ${avg(p.rounds)}<br>H√∂gsta runda: ${p.highest}</div>`;
  });
  html += `<button class="again" onclick="playAgain()">Spela igen</button><button class="exit" onclick="resetAll()">Ny match</button>`;
  winContent.innerHTML = html;
  winModal.classList.add('active');
  localStorage.removeItem('dartsState');
}

function playAgain() {
  winModal.classList.remove('active');
  state.players.forEach(p => {
    p.score = state.start;
    p.legs = 0;
    p.sets = 0;
    p.rounds = [];
    p.setRounds = [];
    p.highest = 0;
  });
  state.leg = 1;
  state.set = 1;
  state.finished = false;
  state.current = state.startIndex;
  state.history = [];
  save();
  render();
}

function initSetup() {
  renderPlayerInputs();
}

document.getElementById('numPlayers').addEventListener('change', initSetup);

initSetup();
load();
</script>
</body>
</html>
